{"version":3,"file":"csharpWatcherService.js","sourceRoot":"","sources":["../../../../../../../../src/vs/workbench/services/files/node/watcher/win32/csharpWatcherService.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n'use strict';\n\nimport cp = require('child_process');\n\nimport {FileChangeType} from 'vs/platform/files/common/files';\nimport decoder = require('vs/base/node/decoder');\nimport glob = require('vs/base/common/glob');\nimport uri from 'vs/base/common/uri';\n\nimport {IRawFileChange} from 'vs/workbench/services/files/node/watcher/common';\n\nexport class OutOfProcessWin32FolderWatcher {\n\n\tprivate static changeTypeMap: FileChangeType[] = [FileChangeType.UPDATED, FileChangeType.ADDED, FileChangeType.DELETED];\n\n\tprivate handle: cp.ChildProcess;\n\n\tconstructor(\n\t\tprivate watchedFolder: string,\n\t\tprivate ignored: string[],\n\t\tprivate eventCallback: (events: IRawFileChange[]) => void,\n\t\tprivate errorCallback: (error: string) => void,\n\t\tprivate verboseLogging: boolean\n\t) {\n\t\tthis.startWatcher();\n\t}\n\n\tprivate startWatcher(): void {\n\t\tlet args = [this.watchedFolder];\n\t\tif (this.verboseLogging) {\n\t\t\targs.push('-verbose');\n\t\t}\n\n\t\tthis.handle = cp.spawn(uri.parse(require.toUrl('vs/workbench/services/files/node/watcher/win32/CodeHelper.exe')).fsPath, args);\n\n\t\tlet stdoutLineDecoder = new decoder.LineDecoder();\n\n\t\t// Events over stdout\n\t\tthis.handle.stdout.on('data', (data: NodeBuffer) => {\n\n\t\t\t// Collect raw events from output\n\t\t\tlet rawEvents: IRawFileChange[] = [];\n\t\t\tstdoutLineDecoder.write(data).forEach((line) => {\n\t\t\t\tlet eventParts = line.split('|');\n\t\t\t\tif (eventParts.length === 2) {\n\t\t\t\t\tlet changeType = Number(eventParts[0]);\n\t\t\t\t\tlet absolutePath = eventParts[1];\n\n\t\t\t\t\t// File Change Event (0 Changed, 1 Created, 2 Deleted)\n\t\t\t\t\tif (changeType >= 0 && changeType < 3) {\n\n\t\t\t\t\t\t// Support ignores\n\t\t\t\t\t\tif (this.ignored && this.ignored.some(ignore => glob.match(ignore, absolutePath))) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Otherwise record as event\n\t\t\t\t\t\trawEvents.push({\n\t\t\t\t\t\t\ttype: OutOfProcessWin32FolderWatcher.changeTypeMap[changeType],\n\t\t\t\t\t\t\tpath: absolutePath\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// 3 Logging\n\t\t\t\t\telse {\n\t\t\t\t\t\tconsole.log('%c[File Watcher]', 'color: darkgreen', eventParts[1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Trigger processing of events through the delayer to batch them up properly\n\t\t\tif (rawEvents.length > 0) {\n\t\t\t\tthis.eventCallback(rawEvents);\n\t\t\t}\n\t\t});\n\n\t\t// Errors\n\t\tthis.handle.on('error', (error: Error) => this.onError(error));\n\t\tthis.handle.stderr.on('data', (data: NodeBuffer) => this.onError(data));\n\n\t\t// Exit\n\t\tthis.handle.on('exit', (code: any, signal: any) => this.onExit(code, signal));\n\t}\n\n\tprivate onError(error: Error | NodeBuffer): void {\n\t\tthis.errorCallback('[FileWatcher] process error: ' + error.toString());\n\t}\n\n\tprivate onExit(code: any, signal: any): void {\n\t\tif (this.handle) { // exit while not yet being disposed is unexpected!\n\t\t\tthis.errorCallback('[FileWatcher] terminated unexpectedly (code: ' + code + ', signal: ' + signal + ')');\n\t\t\tthis.startWatcher(); // restart\n\t\t}\n\t}\n\n\tpublic dispose(): void {\n\t\tif (this.handle) {\n\t\t\tthis.handle.kill();\n\t\t\tthis.handle = null;\n\t\t}\n\t}\n}"]}